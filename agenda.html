<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🧠 Agenda de Pablo 🚆</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🧠</text></svg>">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%234ecdc4' rx='20'/><text x='90' y='120' font-size='100' text-anchor='middle' fill='white'>🧠</text></svg>">
  <meta name="theme-color" content="#4ecdc4">
  <link rel="stylesheet" href="assets/css/main.css">

  <style>
    .btn-icono {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 14px;
      color: white;
      transition: all 0.2s ease;
      min-width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icono:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: scale(1.1);
    }

    .btn-icono:active {
      transform: scale(0.95);
    }

    /* Estilo para el botón principal de tarea universal */
    #btn-tarea-universal {
      background: #4ecdc4 !important;
      border: 2px solid #45b7b8 !important;
      color: white !important;
      transition: all 0.3s ease;
      font-size: 16px !important;
      font-weight: bold !important;
      box-shadow: 0 4px 8px rgba(78, 205, 196, 0.3) !important;
      margin-bottom: 15px !important;
    }

    #btn-tarea-universal:hover {
      background: #45b7b8 !important;
      border-color: #3d9a9b !important;
      transform: scale(1.1);
      box-shadow: 0 6px 12px rgba(78, 205, 196, 0.4) !important;
    }

    /* Modo oscuro */
    .tema-oscuro #btn-tarea-universal {
      background: #5ab3b3 !important;
      border-color: #4a9999 !important;
    }

    .tema-oscuro #btn-tarea-universal:hover {
      background: #4a9999 !important;
      border-color: #3d7f7f !important;
    }
  </style>
</head>

<body>

  <div class="container">
    <div class="header">
      <div style="width:120px; display: flex; align-items: center; justify-content: flex-start;">
        <span style="font-size: 40px; color: #2d5a27;">📋</span>
      </div>
      <div class="header-center">
        <h1 id="titulo-agenda">🧠 Agenda de Pablo 😊</h1>
        <div class="frase-motivacional" id="frase-motivacional" onclick="cambiarFraseMotivacional()"
          title="Haz clic para cambiar la frase">"El éxito es la suma de pequeños esfuerzos repetidos día tras día"
        </div>
        <div class="fecha-actual" id="fecha-actual"
          style="font-size: 28px; font-weight: bold; color: #2d5a27; text-align: center; margin-top: 8px;"></div>
      </div>
      <div style="display: flex; flex-direction: column; align-items: flex-end; width:120px; gap:5px;">
        <button id="btn-pomodoro" class="boton-cargar tooltip" onclick="iniciarPomodoro()"
          style="padding:6px 12px;font-size:12px;" data-tooltip="Pomodoro TDAH">🍅</button>
        <button id="btn-progreso" class="boton-cargar tooltip" onclick="mostrarDashboardMotivacional()"
          style="padding:6px 12px;font-size:12px;" data-tooltip="Mi Progreso">📊</button>
        <button id="btn-resumen" class="boton-cargar tooltip" onclick="mostrarResumenDiarioManual()"
          style="padding:6px 12px;font-size:12px;" data-tooltip="Resumen del Día">🌅</button>
        <button id="btn-config" class="boton-cargar tooltip" onclick="toggleConfigFloating()"
          style="padding:6px 12px;font-size:12px;" data-tooltip="Configuración">⚙️</button>
      </div>
    </div>

    <!-- Bot\u00f3n unificado de calendario -->
    <div class="calendario-unificado" style="display: flex; width: 100%; margin-bottom: 15px; gap: 2px;">
      <button id="btn-calendario-citas" onclick="abrirModalCalendarioConFiltros()" class="boton-cargar calendar-btn"
        style="flex: 1; padding: 8px 16px; font-size: 14px; background: #ff9800; color: white; border: none; border-radius: 4px 0 0 4px; cursor: pointer; transition: all 0.2s ease;">
        📅 Calendario
      </button>
      <button id="btn-tarea-crear" onclick="abrirModalTareaUniversal()" class="boton-cargar tooltip"
        style="flex: 1; padding: 8px 16px; font-size: 14px; background: #4ecdc4; color: white; border: none; border-radius: 0 4px 4px 0; cursor: pointer; transition: all 0.2s ease; font-weight: bold;"
        data-tooltip="Crear tareas en cualquier lista">
        ➕ CREAR TAREA
      </button>
    </div>


    <div id="alertas"></div>

    <div class="contenedor-dos-columnas">
      <div class="columna-izquierda">
        <section class="drop-zone" data-target="criticas">
          <h3>🚨 Tareas Críticas 🚨</h3>

          <div class="filtros-container">
            <button class="filtros-toggle" onclick="toggleFiltros('criticas')">
              <span>🔍 Filtros</span>
              <span id="filtros-icon-criticas">▼</span>
            </button>
            <div id="filtros-content-criticas" class="filtros-content">
              <div class="filtros-grid">
                <div class="filtro-grupo">
                  <label class="filtro-label">Estado</label>
                  <select id="filtro-estado-criticas" class="filtro-select" onchange="aplicarFiltros()">
                    <option value="">Todos</option>
                    <option value="pendiente">Pendientes</option>
                    <option value="migrada">Migradas</option>
                    <option value="programada">Programadas</option>
                    <option value="completada">Completadas</option>
                  </select>
                </div>
                <div class="filtro-grupo">
                  <label class="filtro-label">Fecha</label>
                  <select id="filtro-fecha-criticas" class="filtro-select" onchange="aplicarFiltros()">
                    <option value="">Todas</option>
                    <option value="hoy">Hoy</option>
                    <option value="pasadas">Pasadas</option>
                    <option value="proximas">Próximas</option>
                    <option value="sin-fecha">Sin fecha</option>
                  </select>
                </div>
                <div class="filtro-grupo">
                  <label class="filtro-label">Persona</label>
                  <select id="filtro-persona-criticas" class="filtro-select" onchange="aplicarFiltros()">
                    <option value="">Todas</option>
                  </select>
                </div>
                <div class="filtro-grupo">
                  <label class="filtro-label">Etiqueta</label>
                  <select id="filtro-etiqueta-criticas" class="filtro-select" onchange="aplicarFiltros()">
                    <option value="">Todas</option>
                  </select>
                </div>
                <div class="filtro-grupo">
                  <button class="btn-limpiar-filtros" onclick="limpiarFiltros('criticas')">Limpiar</button>
                </div>
              </div>
            </div>
          </div>

          <div id="lista-criticas"></div>
          <button class="boton-agregar tooltip" onclick="nuevaTareaCritica()" data-tooltip="Crear nueva tarea crítica">➕
            Añadir tarea crítica</button>
        </section>

        <section>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">📅 Citas</h3>
            <div style="display: flex; gap: 3px; flex-wrap: wrap;">
              <button onclick="abrirModalNuevaCita()" class="boton-cargar calendar-btn"
                style="padding: 4px 8px; font-size: 10px; background: #4ecdc4; color: white;">➕</button>
              <button onclick="abrirModalCitasRelativas()" class="boton-cargar calendar-btn"
                style="padding: 4px 8px; font-size: 10px; background: #9c27b0; color: white;">📅+</button>
              <button onclick="abrirModalCitaPeriodica()" class="boton-cargar calendar-btn"
                style="padding: 4px 8px; font-size: 10px; background: #e91e63; color: white;">🔄</button>
            </div>
          </div>
          <div style="margin-bottom: 10px;">
            <select id="filtro-citas" onchange="cambiarFiltroCitas()"
              style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ddd; font-size: 12px;">
              <option value="todas">Todas las citas</option>
              <option value="proximas">15 días atrás + 30 adelante</option>
            </select>
          </div>
          <div id="citas-panel" style="max-height:200px;overflow-y:auto;"></div>

          <!-- Calendario integrado en la página -->
          <div id="calendario-citas-integrado"
            style="display:none;margin-top:15px;border:1px solid #ddd;border-radius:8px;padding:10px;background:#f9f9f9;">
            <div class="calendar-header"
              style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
              <button id="prevMonthIntegrado" class="calendar-nav-btn"
                style="padding:5px 10px;background:#4ecdc4;color:white;border:none;border-radius:4px;cursor:pointer;">◀</button>
              <h4 id="monthYearIntegrado" style="margin:0;font-size:14px;"></h4>
              <button id="nextMonthIntegrado" class="calendar-nav-btn"
                style="padding:5px 10px;background:#4ecdc4;color:white;border:none;border-radius:4px;cursor:pointer;">▶</button>
            </div>
            <div class="calendar-weekdays"
              style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:5px;">
              <div style="text-align:center;font-size:10px;font-weight:bold;padding:3px;">Lun</div>
              <div style="text-align:center;font-size:10px;font-weight:bold;padding:3px;">Mar</div>
              <div style="text-align:center;font-size:10px;font-weight:bold;padding:3px;">Mié</div>
              <div style="text-align:center;font-size:10px;font-weight:bold;padding:3px;">Jue</div>
              <div style="text-align:center;font-size:10px;font-weight:bold;padding:3px;">Vie</div>
              <div style="text-align:center;font-size:10px;font-weight:bold;padding:3px;">Sáb</div>
              <div style="text-align:center;font-size:10px;font-weight:bold;padding:3px;">Dom</div>
            </div>
            <div class="calendar-grid" id="calendarGridIntegrado"
              style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;min-height:200px;"></div>
            <div id="appointmentsListIntegrado" style="margin-top:10px;max-height:150px;overflow-y:auto;"></div>
          </div>
        </section>

        <section id="seccion-notas" style="display: block;">
          <h3>📝 Notas / Brain Dump</h3>
          <textarea id="notas-texto" placeholder="Escribe aquí tus notas, ideas, recordatorios..."></textarea>
        </section>

        <section id="seccion-sentimientos" style="display: block;">
          <h3>😊 ¿Cómo te sientes?</h3>
          <textarea id="sentimientos-texto"
            placeholder="Describe cómo te sientes hoy, tus emociones, pensamientos..."></textarea>
        </section>

        <section id="seccion-contrasenas" style="display: block;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">🔐 Contraseñas Encriptadas</h3>
            <button onclick="abrirModalNuevaContrasena()" class="boton-agregar"
              style="padding: 6px 12px; font-size: 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">
              ➕ Nueva Contraseña
            </button>
          </div>
          <div id="lista-contrasenas">
            <p style="text-align: center; color: #666; font-style: italic;">
              Carga las contraseñas guardadas o agrega una nueva.
            </p>
          </div>
        </section>
      </div>

      <div class="columna-derecha">
        <section class="drop-zone" data-target="tareas">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">✅ Lista para hacer</h3>
            <div style="display: flex; gap: 3px; flex-wrap: wrap;">
              <button onclick="abrirEditorTarea(null, 'tarea')" class="boton-cargar"
                style="padding: 4px 8px; font-size: 10px; background: #4ecdc4; color: white;">+</button>
            </div>
          </div>

          <div class="filtros-container">
            <button class="filtros-toggle" onclick="toggleFiltros('tareas')">
              <span>🔍 Filtros</span>
              <span id="filtros-icon-tareas">▼</span>
            </button>
            <div id="filtros-content-tareas" class="filtros-content">
              <div class="filtros-grid">
                <div class="filtro-grupo">
                  <label class="filtro-label">Estado</label>
                  <select id="filtro-estado-tareas" class="filtro-select" onchange="aplicarFiltros()">
                    <option value="">Todos</option>
                    <option value="pendiente">Pendientes</option>
                    <option value="migrada">Migradas</option>
                    <option value="programada">Programadas</option>
                    <option value="completada">Completadas</option>
                  </select>
                </div>
                <div class="filtro-grupo">
                  <label class="filtro-label">Fecha</label>
                  <select id="filtro-fecha-tareas" class="filtro-select" onchange="aplicarFiltros()">
                    <option value="">Todas</option>
                    <option value="hoy">Hoy</option>
                    <option value="pasadas">Pasadas</option>
                    <option value="proximas">Próximas</option>
                    <option value="sin-fecha">Sin fecha</option>
                  </select>
                </div>
                <div class="filtro-grupo">
                  <label class="filtro-label">Persona</label>
                  <select id="filtro-persona-tareas" class="filtro-select" onchange="aplicarFiltros()">
                    <option value="">Todas</option>
                  </select>
                </div>
                <div class="filtro-grupo">
                  <label class="filtro-label">Etiqueta</label>
                  <select id="filtro-etiqueta-tareas" class="filtro-select" onchange="aplicarFiltros()">
                    <option value="">Todas</option>
                  </select>
                </div>
                <div class="filtro-grupo">
                  <button class="btn-limpiar-filtros" onclick="limpiarFiltros('tareas')">Limpiar</button>
                </div>
              </div>
            </div>
          </div>

          <div id="lista-tareas"></div>
          <button class="boton-agregar tooltip" onclick="nuevaTarea()" data-tooltip="Crear nueva tarea">➕
            Añadir tarea</button>
        </section>
      </div>
    </div>

    <!-- Modal de citas relativas -->
    <div id="modal-citas-relativas" class="modal">
      <div class="modal-content" style="max-width: 500px;">
        <h4>📅 Citas Relativas</h4>
        <div id="citas-relativas-contenedor">
          <button onclick="agregarCitaRelativa()" class="boton-agregar"
            style="width:100%;margin-bottom:10px;">➕ Añadir cita</button>
        </div>
        <div class="modal-botones">
          <button class="btn-primario" onclick="guardarCitasRelativas()">Guardar todas</button>
          <button class="btn-secundario" onclick="cerrarModal('modal-citas-relativas')">Cancelar</button>
        </div>
      </div>
    </div>

            <!-- Modal Pomodoro -->
            <div id="modal-pomodoro" class="modal">
              <div class="modal-content" style="max-width:400px;text-align:center;">
                <h4 id="pomodoro-titulo">🍅 Pomodoro TDAH</h4>
                <div id="pomodoro-estado-inicial">
                  <div style="margin-bottom:20px;">
                    <label style="font-weight:500;margin-bottom:10px;display:block;">¿Qué estás haciendo ahora?</label>
                    <input type="text" id="pomodoro-actividad" placeholder="Estudiar, trabajar, organizar..."
                      style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                  </div>
                  <div style="margin-bottom:20px;">
                    <label style="font-weight:500;margin-bottom:10px;display:block;">Duración (minutos):</label>
                    <input type="number" id="pomodoro-duracion" value="25" min="1" max="180"
                      style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                  </div>
                  <div class="modal-botones">
                    <button class="btn-primario" onclick="empezarPomodoro()">🚀 Empezar</button>
                    <button class="btn-secundario" onclick="cerrarModal('modal-pomodoro')">Cancelar</button>
                  </div>
                </div>

                <div id="pomodoro-en-curso" style="display:none;">
                  <div style="font-size:18px;margin-bottom:15px;color:#2c5aa0;">
                    <strong>Haciendo:</strong> <span id="actividad-actual"></span>
                  </div>
                  <div id="cronometro" style="font-size:48px;font-weight:bold;color:#e74c3c;margin:20px 0;">
                    25:00
                  </div>
                  <div class="modal-botones">
                    <button class="btn-primario" onclick="terminarPomodoro()">✅ Terminar</button>
                    <button class="btn-secundario" onclick="pausarPomodoro()" id="btn-pausar">⏸️ Pausar</button>
                    <button class="btn-secundario" onclick="cancelarPomodoro()">❌ Cancelar</button>
                  </div>
                </div>

                <div id="pomodoro-completado" style="display:none;">
                  <div style="font-size:64px;margin:20px 0;">🎉</div>
                  <h3 style="color:#27ae60;">¡Pomodoro Completado!</h3>
                  <div style="margin:15px 0;color:#666;">
                    Has trabajado en: <strong id="actividad-completada"></strong>
                  </div>
                  <div class="modal-botones">
                    <button class="btn-primario" onclick="nuevoPomodoro()">🔄 Nuevo Pomodoro</button>
                    <button class="btn-secundario" onclick="cerrarModal('modal-pomodoro')">Cerrar</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modal para nueva tarea crítica -->
            <div id="modal-critica" class="modal">
              <div class="modal-content">
                <h4>🚨 Nueva Tarea Crítica</h4>
                <div class="form-group">
                  <label>Título:</label>
                  <input type="text" id="critica-titulo" class="form-control" placeholder="¿Qué necesitas hacer urgentemente?">
                </div>
                <div class="form-group">
                  <label>Fecha límite:</label>
                  <input type="date" id="critica-fecha" class="form-control">
                </div>
                <div class="form-group">
                  <label>Etiqueta:</label>
                  <select id="critica-etiqueta" class="form-control">
                    <option value="">Sin etiqueta</option>
                  </select>
                </div>
                <div class="modal-botones">
                  <button class="btn-primario" onclick="agregarTareaCritica()">Agregar</button>
                  <button class="btn-secundario" onclick="cerrarModal('modal-critica')">Cancelar</button>
                </div>
              </div>
            </div>

            <!-- Modal para nueva tarea normal -->
            <div id="modal-tarea" class="modal">
              <div class="modal-content">
                <h4>✅ Nueva Tarea</h4>
                <div class="form-group">
                  <label>¿Qué necesitas hacer?</label>
                  <input type="text" id="tarea-texto" class="form-control" placeholder="Describe la tarea...">
                </div>
                <div class="form-group">
                  <label>Fecha límite (opcional):</label>
                  <input type="date" id="tarea-fecha" class="form-control">
                </div>
                <div class="form-group">
                  <label>Etiqueta:</label>
                  <select id="tarea-etiqueta" class="form-control">
                    <option value="">Sin etiqueta</option>
                  </select>
                </div>
                <div class="modal-botones">
                  <button class="btn-primario" onclick="agregarTarea()">Agregar</button>
                  <button class="btn-secundario" onclick="cerrarModal('modal-tarea')">Cancelar</button>
                </div>
              </div>
            </div>

            <!-- Modal para migrar tarea -->
            <div id="modal-migrar" class="modal">
              <div class="modal-content">
                <h4>→ Migrar Tarea</h4>
                <div class="form-group">
                  <label>Nueva fecha:</label>
                  <input type="date" id="migrar-fecha" class="form-control">
                </div>
                <div class="form-group">
                  <label>Persona asignada (opcional):</label>
                  <input type="text" id="migrar-persona" class="form-control" placeholder="Nombre de la persona">
                </div>
                <div class="modal-botones">
                  <button class="btn-primario" onclick="guardarMigracion()">Migrar</button>
                  <button class="btn-secundario" onclick="cerrarModal('modal-migrar')">Cancelar</button>
                </div>
              </div>
            </div>

            <!-- Supabase CDN -->
            <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

            <!-- Scripts modulares -->
            <script src="assets/js/tareas.js"></script>
            <script src="assets/js/app.js"></script>
            <script src="assets/js/calendario.js"></script>
            <script src="assets/js/sincronizacion-simple.js"></script>
            <script src="assets/js/supabase-sync.js"></script>
            <script src="assets/js/historial-viewer.js"></script>
            <script src="assets/js/rendimiento.js"></script>
            <script src="assets/js/compatibility.js"></script>
            <script src="assets/js/restore-backup.js"></script> <!-- TEMPORAL: Para restaurar backup -->

            <!-- Funciones para filtros de calendario -->
            <script>
              function aplicarFiltrosCalendario() {
                const mostrarCitas = document.getElementById('filtro-citas').checked;
                const mostrarTareas = document.getElementById('filtro-tareas').checked;

                console.log('Filtros aplicados - Citas:', mostrarCitas, 'Tareas:', mostrarTareas);

                // Actualizar título
                const titulo = document.getElementById('titulo-lista-calendario');
                if (mostrarCitas && mostrarTareas) {
                  titulo.textContent = '📋 Próximos 30 días: Citas y Tareas';
                } else if (mostrarCitas) {
                  titulo.textContent = '📅 Próximos 30 días: Solo Citas';
                } else if (mostrarTareas) {
                  titulo.textContent = '✅ Próximos 30 días: Solo Tareas';
                } else {
                  titulo.textContent = '📋 Ningún elemento seleccionado';
                }

                // Guardar configuración de filtros
                guardarFiltrosCalendario(mostrarCitas, mostrarTareas);

                // Mostrar elementos según filtros
                mostrarElementosDelMes(mostrarCitas, mostrarTareas);
              }

              function mostrarElementosDelMes(mostrarCitas, mostrarTareas) {
                const lista = document.getElementById('allAppointmentsList');
                lista.innerHTML = '';

                if (!mostrarCitas && !mostrarTareas) {
                  lista.innerHTML = '<p style="color:#999;font-style:italic;text-align:center;padding:20px;">Selecciona qué elementos mostrar</p>';
                  return;
                }

                // Obtener rango de próximos 30 días
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0); // Inicio del día actual

                const en30Dias = new Date(hoy);
                en30Dias.setDate(hoy.getDate() + 30); // 30 días desde hoy

                let elementos = [];

                // Obtener citas si está seleccionado
                if (mostrarCitas && window.appState?.agenda?.citas) {
                  const citas = window.appState.agenda.citas.filter(cita => {
                    if (!cita || !cita.fecha || !Array.isArray(cita.fecha)) return false;
                    const [año, mes, dia] = cita.fecha;
                    const fechaCita = new Date(año, mes - 1, dia); // mes array es 1-12, Date usa 0-11
                    fechaCita.setHours(0, 0, 0, 0);
                    return fechaCita >= hoy && fechaCita <= en30Dias;
                  }).map(cita => ({
                    ...cita,
                    tipo: 'cita',
                    icono: '📅',
                    color: '#ff9800',
                    titulo: cita.nombre, // Las citas usan 'nombre' no 'titulo'
                    fechaParaOrden: new Date(cita.fecha[0], cita.fecha[1] - 1, cita.fecha[2]) // Para ordenar
                  }));
                  elementos.push(...citas);
                }

                // Obtener tareas si está seleccionado
                if (mostrarTareas && window.appState?.agenda?.tareas) {
                  const tareas = window.appState.agenda.tareas.filter(tarea => {
                    if (!tarea || !tarea.fecha_fin) return false;
                    const fechaTarea = new Date(tarea.fecha_fin);
                    fechaTarea.setHours(0, 0, 0, 0);
                    return fechaTarea >= hoy && fechaTarea <= en30Dias;
                  }).map(tarea => ({
                    ...tarea,
                    tipo: 'tarea',
                    icono: '✅',
                    color: '#4ecdc4',
                    titulo: tarea.texto,
                    fechaParaOrden: new Date(tarea.fecha_fin) // Para ordenar
                  }));
                  elementos.push(...tareas);
                }

                // Ordenar por fecha
                elementos.sort((a, b) => {
                  return a.fechaParaOrden - b.fechaParaOrden;
                });

                // Mostrar elementos
                if (elementos.length === 0) {
                  lista.innerHTML = '<p style="color:#999;font-style:italic;text-align:center;padding:20px;">No hay elementos en los próximos 30 días</p>';
                } else {
                  elementos.forEach(elemento => {
                    const fechaStr = elemento.fechaParaOrden.toLocaleDateString('es-ES', {
                      day: 'numeric',
                      month: 'short'
                    });

                    const div = document.createElement('div');
                    div.style.cssText = `
            padding: 8px;
            margin-bottom: 6px;
            border-radius: 6px;
            border-left: 4px solid ${elemento.color};
            background: rgba(${elemento.color === '#ff9800' ? '255,152,0' : '78,205,196'}, 0.1);
            font-size: 13px;
            line-height: 1.3;
          `;

                    div.innerHTML = `
            <div style="display:flex;align-items:center;gap:6px;">
              <span style="font-size:14px;">${elemento.icono}</span>
              <span style="font-weight:500;color:#2c3e50;">${elemento.titulo || elemento.descripcion}</span>
            </div>
            <div style="font-size:11px;color:#666;margin-top:2px;">${fechaStr}</div>
          `;

                    lista.appendChild(div);
                  });
                }
              }

              function marcarTodos(seleccionar) {
                console.log('🔄 Marcando todos:', seleccionar);

                const citasCheckbox = document.getElementById('filtro-citas');
                const tareasCheckbox = document.getElementById('filtro-tareas');

                if (citasCheckbox) citasCheckbox.checked = seleccionar;
                if (tareasCheckbox) tareasCheckbox.checked = seleccionar;

                console.log('✅ Estados después del cambio:', {
                  citas: citasCheckbox?.checked,
                  tareas: tareasCheckbox?.checked
                });

                aplicarFiltrosCalendario();
              }

              function guardarFiltrosCalendario(citas, tareas) {
                // Asegurar que existe window.configVisual
                if (!window.configVisual) window.configVisual = {};

                // Guardar filtros
                window.configVisual.filtrosCalendario = {
                  citas: citas,
                  tareas: tareas
                };

                // Guardar configuración
                if (typeof guardarConfigEnSupabase === 'function') {
                  guardarConfigEnSupabase();
                  console.log('✅ Filtros de calendario guardados');
                }
              }

              function cargarFiltrosCalendario() {
                const config = window.configVisual || {};
                const filtros = config.filtrosCalendario || { citas: true, tareas: false };

                // Aplicar filtros guardados
                document.getElementById('filtro-citas').checked = filtros.citas;
                document.getElementById('filtro-tareas').checked = filtros.tareas;

                // Actualizar título
                aplicarFiltrosCalendario();
              }
            </script>

            <!-- Modal de Configuración -->
            <div id="modal-config" class="modal">
              <div class="modal-content"
                style="max-width: 800px; height: 80vh; display: flex; flex-direction: column; padding: 30px;">
                <div class="modal-header"
                  style="padding: 0 0 15px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; margin: -30px -30px 20px -30px; padding: 15px 30px;">
                  <h3 style="margin: 0;">⚙️ Configuración</h3>
                  <span class="close" onclick="cerrarModal('modal-config')"
                    style="cursor: pointer; font-size: 24px;">&times;</span>
                </div>

                <div class="config-tabs"
                  style="display: flex; background: #f8f9fa; border-bottom: 1px solid #ddd; overflow-x: auto; margin: 0 -30px 20px -30px; padding: 15px 30px 0 30px;">
                  <button class="config-tab active" onclick="switchTab('visual')">🎨 Visual</button>
                  <button class="config-tab" onclick="switchTab('funcionales')">🛠️ Funcionales</button>
                  <button class="config-tab" onclick="switchTab('opciones')">⚙️ Opciones</button>
                  <button class="config-tab" onclick="switchTab('supabase')">☁️ Supabase</button>
                  <button class="config-tab" onclick="switchTab('etiquetas')">🏷️ Etiquetas</button>
                  <button class="config-tab" onclick="switchTab('personas')">👥 Personas</button>
                  <button class="config-tab" onclick="switchTab('backups')">💾 Backups</button>
                  <button class="config-tab" onclick="switchTab('log')">📋 Log</button>
                </div>

                <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 0;">

                  <!-- Tab Visual -->
                  <div id="tab-visual" class="tab-content active">
                    <h4>Apariencia</h4>
                    <div class="form-group">
                      <label>Tema de color:</label>
                      <select id="config-tema-select" class="form-control" onchange="guardarConfigVisualPanel()">
                        <option value="verde">Verde (Original)</option>
                        <option value="azul">Azul Profesional</option>
                        <option value="rosa">Rosa Suave</option>
                        <option value="oscuro">Modo Oscuro</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Título de la Agenda:</label>
                      <input type="text" id="config-titulo-input" class="form-control"
                        onchange="guardarConfigVisualPanel()">
                    </div>

                    <h4>Visualización</h4>
                    <div class="form-group">
                      <label>Modo de visualización:</label>
                      <select id="config-modo-visualizacion" class="form-control" onchange="guardarConfigVisualPanel()">
                        <option value="estado">Por Estado (Pendiente/Completada)</option>
                        <option value="prioridad">Por Prioridad (Crítica/Normal)</option>
                        <option value="fecha">Por Fecha de Vencimiento</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Columnas de tareas:</label>
                      <select id="config-columnas" class="form-control" onchange="guardarConfigVisualPanel()">
                        <option value="1">1 Columna (Móvil)</option>
                        <option value="2">2 Columnas (Estándar)</option>
                        <option value="3">3 Columnas (Ancho)</option>
                      </select>
                    </div>

                    <h4>Elementos Visibles</h4>
                    <div class="checkbox-group">
                      <label><input type="checkbox" id="config-popup-celebracion" onchange="guardarConfigVisualPanel()">
                        Mostrar celebración al completar</label>
                      <label><input type="checkbox" id="config-mostrar-notas" onchange="guardarConfigVisualPanel()">
                        Mostrar panel de Notas</label>
                      <label><input type="checkbox" id="config-mostrar-sentimientos"
                          onchange="guardarConfigVisualPanel()"> Mostrar panel de Sentimientos</label>
                      <label><input type="checkbox" id="config-mostrar-contrasenas"
                          onchange="guardarConfigVisualPanel()"> Mostrar panel de Contraseñas</label>
                      <label><input type="checkbox" id="config-mostrar-pomodoro" onchange="guardarConfigVisualPanel()">
                        Mostrar Pomodoro</label>
                      <label><input type="checkbox" id="config-mostrar-progreso" onchange="guardarConfigVisualPanel()">
                        Mostrar Barra de Progreso</label>
                      <label><input type="checkbox" id="config-mostrar-resumen" onchange="guardarConfigVisualPanel()">
                        Mostrar Resumen Diario</label>
                      <label><input type="checkbox" id="config-mostrar-tarea-universal"
                          onchange="guardarConfigVisualPanel()"> Mostrar Tarea Universal</label>
                    </div>

                    <h4>Listas Personalizadas</h4>
                    <div id="listas-personalizadas-contenido" style="margin-top: 10px;">
                      <!-- Las listas personalizadas se renderizarán aquí dinámicamente -->
                    </div>
                  </div>

                  <!-- Tab Funcionales -->
                  <div id="tab-funcionales" class="tab-content">
                    <h4>Comportamiento</h4>
                    <div class="checkbox-group">
                      <label><input type="checkbox" id="config-salvado-automatico"
                          onchange="guardarConfigFuncionales()"> Guardar backup diario automáticamente</label>
                      <label><input type="checkbox" id="config-limpiar-completadas"
                          onchange="guardarConfigFuncionales()"> Limpiar tareas completadas al iniciar día</label>
                      <label><input type="checkbox" id="config-confirmar-borrado" onchange="guardarConfigFuncionales()">
                        Confirmar antes de borrar</label>
                    </div>
                  </div>

                  <!-- Tab Opciones -->
                  <div id="tab-opciones" class="tab-content">
                    <h4>Opciones Generales</h4>
                    <div class="checkbox-group">
                      <label><input type="checkbox" id="config-sin-tactil" onchange="guardarConfigOpciones()"> Modo
                        escritorio (sin optimización táctil)</label>
                      <label><input type="checkbox" id="config-mostrar-todo" onchange="guardarConfigOpciones()"> Mostrar
                        todas las opciones avanzadas</label>
                      <label><input type="checkbox" id="config-botones-borrar" onchange="guardarConfigOpciones()">
                        Mostrar botones de borrar siempre</label>
                    </div>
                  </div>

                  <!-- Tab Supabase -->
                  <div id="tab-supabase" class="tab-content">
                    <div class="supabase-config-panel">
                      <div style="text-align: center; margin-bottom: 20px;">
                        <span style="font-size: 48px; color: #3ECF8E;">⚡</span>
                        <h3 style="color: #3ECF8E;">Sincronización Supabase</h3>
                        <p>Tus datos seguros y sincronizados en tiempo real</p>
                      </div>

                      <div id="supabase-status-panel"
                        style="background: #f0fdf4; padding: 15px; border-radius: 8px; border: 1px solid #bbf7d0; margin-bottom: 20px; display: none;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                          <div
                            style="width: 12px; height: 12px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 0 4px #dcfce7;">
                          </div>
                          <div>
                            <strong style="color: #15803d;">Conectado y Sincronizando</strong>
                            <div style="font-size: 12px; color: #166534;">Última sincronización: <span
                                id="supabase-last-sync">Hace un momento</span></div>
                          </div>
                        </div>
                      </div>

                      <div class="form-group">
                        <label>URL del Proyecto Supabase:</label>
                        <input type="text" id="supabase-url" class="form-control" placeholder="https://xyz.supabase.co">
                      </div>
                      <div class="form-group">
                        <label>API Key (anon/public):</label>
                        <input type="password" id="supabase-key" class="form-control"
                          placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                        <small style="color: #666;">Esta clave es segura de usar en el cliente.</small>
                      </div>

                      <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="guardarConfiguracionSupabase()" class="btn-primario"
                          style="background: #3ECF8E; flex: 1;">Conectar</button>
                        <button onclick="probarConexionSupabase()" class="btn-secundario">Probar Conexión</button>
                      </div>

                      <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                        <h4>🛠️ Herramientas de Datos</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                          <button onclick="supabasePush()" class="btn-secundario" style="font-size: 12px;">⬆️ Forzar
                            Subida (Push)</button>
                          <button onclick="supabasePull()" class="btn-secundario" style="font-size: 12px;">⬇️ Forzar
                            Bajada (Pull)</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Tab Etiquetas -->
                  <div id="tab-etiquetas" class="tab-content">
                    <h4>Gestión de Etiquetas</h4>
                    <div id="lista-etiquetas-config" style="margin-bottom: 15px;"></div>
                    <div style="display: flex; gap: 10px;">
                      <input type="text" id="nueva-etiqueta-nombre" class="form-control" placeholder="Nueva etiqueta">
                      <input type="color" id="nueva-etiqueta-color" value="#4ecdc4"
                        style="height: 38px; width: 50px; padding: 0; border: none;">
                      <button onclick="crearNuevaEtiqueta()" class="btn-primario">+</button>
                    </div>
                  </div>

                  <!-- Tab Personas -->
                  <div id="tab-personas" class="tab-content">
                    <h4>Gestión de Personas</h4>
                    <div id="personas-lista" style="margin-bottom: 15px;"></div>
                    <div style="display: flex; gap: 10px;">
                      <input type="text" id="nueva-persona-nombre" class="form-control"
                        placeholder="Nombre de la persona">
                      <button onclick="agregarPersona()" class="btn-primario">Añadir</button>
                    </div>
                  </div>

                  <!-- Tab Backups -->
                  <div id="tab-backups" class="tab-content">
                    <h4>Copias de Seguridad</h4>
                    <div class="form-group">
                      <label>Crear nuevo backup:</label>
                      <button onclick="crearBackupManual()" class="btn-primario" style="width: 100%;">💾 Crear Backup
                        Ahora</button>
                    </div>
                    <hr>
                    <div class="form-group">
                      <label>Restaurar backup:</label>
                      <select id="select-salvado" class="form-control"></select>
                      <button onclick="restaurarSalvado(document.getElementById('select-salvado').value)"
                        class="btn-secundario"
                        style="width: 100%; margin-top: 10px; background: #ff9800; color: white;">⚠️ Restaurar
                        Seleccionado</button>
                    </div>
                  </div>

                  <!-- Tab Log -->
                  <div id="tab-log" class="tab-content">
                    <div
                      style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                      <h4>Registro de Actividad</h4>
                      <div>
                        <button onclick="exportarLog()" class="btn-secundario"
                          style="padding: 5px 10px; font-size: 12px;">📥 Exportar</button>
                        <button onclick="limpiarLog()" class="btn-secundario"
                          style="padding: 5px 10px; font-size: 12px; background: #ffebee; color: #c62828;">🗑️
                          Limpiar</button>
                      </div>
                    </div>
                    <div id="log-container"
                      style="background: #f8f9fa; border: 1px solid #eee; border-radius: 6px; height: 300px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px;">
                      <div style="text-align: center; color: #999; padding-top: 100px;">Cargando registro...</div>

                      <div style="display: flex; align-items: center; gap: 6px; opacity: 0.9;">
                        <span style="font-size: 10px;">💻</span>
                        <span>Created by <strong>linuxesdios</strong></span>
                      </div>

                      <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(255,255,255,0.2);">
                        <a href="https://github.com/linuxesdios/AgendaGitSyncro" target="_blank"
                          style="color: #4ecdc4; text-decoration: none; display: flex; align-items: center; gap: 4px; font-size: 10px;"
                          onmouseover="this.style.color='#45b7b8'" onmouseout="this.style.color='#4ecdc4'">
                          <span>🐙</span>
                          <span>GitHub</span>
                        </a>

                        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank"
                          style="color: #ffd700; text-decoration: none; display: flex; align-items: center; gap: 4px; font-size: 10px;"
                          onmouseover="this.style.color='#ffed4e'" onmouseout="this.style.color='#ffd700'">
                          <span>⚖️</span>
                          <span>CC BY-NC-SA 4.0</span>
                        </a>
                      </div>

                      <!-- Botón para minimizar -->
                      <button
                        onclick="this.parentElement.style.transform='translateX(calc(100% - 40px))'; this.innerHTML='👁️'"
                        style="position: absolute; top: 5px; right: 5px; background: none; border: none; color: white; cursor: pointer; font-size: 10px; opacity: 0.7; padding: 2px;"
                        onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'"
                        title="Minimize footer">✖️</button>
                      </footer>

</body>

</html>